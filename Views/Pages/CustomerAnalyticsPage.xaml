<base:BaseAnimatedPage
    x:Class="PrimeAppBooks.Views.Pages.CustomerAnalyticsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:base="clr-namespace:PrimeAppBooks.Views.Pages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="900"
    d:DesignWidth="1280"
    Background="Transparent"
    mc:Ignorable="d">

    <ScrollViewer Style="{StaticResource ModernScrollViewer}">
        <Grid Margin="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!--  Header  -->
            <Border
                Grid.Row="0"
                Margin="0,0,0,20"
                Style="{StaticResource ModernCardStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <Button
                        Grid.Column="0"
                        Height="Auto"
                        Margin="0,0,15,0"
                        VerticalAlignment="Center"
                        Command="{Binding GoBackCommand}"
                        Content="â—€"
                        FontSize="16"
                        Foreground="White"
                        Style="{StaticResource ModernIconButton}"
                        ToolTip="Go back" />

                    <StackPanel Grid.Column="1">
                        <TextBlock Style="{StaticResource WelcomeTitleText}" Text="Customer Analytics and Debtor Performance" />
                        <TextBlock Style="{StaticResource WelcomeSubtitleText}" Text="Comprehensive overview of receivables aging and collection efficiency" />
                    </StackPanel>
                </Grid>
            </Border>

            <!--  KPI Cards  -->
            <UniformGrid
                Grid.Row="1"
                Margin="10"
                Columns="3">
                <Border Style="{StaticResource ModernCardStyle}">
                    <StackPanel Style="{StaticResource CardContentContainer}">
                        <TextBlock
                            FontSize="14"
                            Foreground="#7F8C8D"
                            Text="Total Receivables" />
                        <TextBlock Style="{StaticResource CardValueText}" Text="{Binding TotalReceivables, StringFormat=C}" />
                        <TextBlock Style="{StaticResource CardSubText}" Text="Active outstanding balance" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource ModernCardStyle}">
                    <StackPanel Style="{StaticResource CardContentContainer}">
                        <TextBlock
                            FontSize="14"
                            Foreground="#FF6B6B"
                            Text="Total Overdue" />
                        <TextBlock
                            Foreground="#FF6B6B"
                            Style="{StaticResource CardValueText}"
                            Text="{Binding TotalOverdue, StringFormat=C}" />
                        <TextBlock Style="{StaticResource CardSubText}" Text="Past due date" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource ModernCardStyle}">
                    <StackPanel Style="{StaticResource CardContentContainer}">
                        <TextBlock
                            FontSize="14"
                            Foreground="#2ECC71"
                            Text="Avg Days to Pay (DSO)" />
                        <TextBlock
                            Foreground="#2ECC71"
                            Style="{StaticResource CardValueText}"
                            Text="{Binding AverageDso, StringFormat={}{0:F1} Days}" />
                        <TextBlock Style="{StaticResource CardSubText}" Text="Collection efficiency" />
                    </StackPanel>
                </Border>
            </UniformGrid>

            <!--  Charts and Detailed List  -->
            <Grid Grid.Row="2">
                <!--  Aging Chart  -->
                <Border Style="{StaticResource ModernCardStyle}">
                    <StackPanel>
                        <TextBlock
                            Margin="0,0,0,15"
                            Style="{StaticResource SectionHeaderText}"
                            Text="Receivables Aging Report" />
                        <lvc:CartesianChart
                            Height="300"
                            LegendLocation="None"
                            Series="{Binding AgingSeries}">
                            <lvc:CartesianChart.AxisX>
                                <lvc:Axis Title="Days Past Due" Labels="{Binding AgingLabels}" />
                            </lvc:CartesianChart.AxisX>
                            <lvc:CartesianChart.AxisY>
                                <lvc:Axis Title="Amount" LabelFormatter="{Binding Formatter}" />
                            </lvc:CartesianChart.AxisY>
                        </lvc:CartesianChart>
                    </StackPanel>
                </Border>
            </Grid>

            <!--  Detailed List  -->
            <Grid Grid.Row="3">
                <!--  Debtor List  -->
                <Border Grid.Column="1" Style="{StaticResource ModernCardStyle}">
                    <DockPanel>
                        <TextBlock
                            Margin="0,0,0,15"
                            DockPanel.Dock="Top"
                            Style="{StaticResource SectionHeaderText}"
                            Text="Debtor Analysis List" />
                        <DataGrid
                            MaxHeight="400"
                            HorizontalAlignment="Stretch"
                            AutoGenerateColumns="False"
                            BorderThickness="0"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            GridLinesVisibility="None"
                            IsReadOnly="True"
                            ItemsSource="{Binding DebtorList}"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            Style="{StaticResource ModernDataGridStyle}">

                            <!--  Set row height and vertical alignment with enhanced selection state  -->
                            <DataGrid.RowStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridRow}" TargetType="DataGridRow">
                                    <Setter Property="Height" Value="60" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="VerticalAlignment" Value="Center" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="Foreground" Value="White" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#2A4A7B" />
                                            <!--  Selected background color  -->
                                            <Setter Property="BorderBrush" Value="#4472C4" />
                                            <Setter Property="BorderThickness" Value="1" />
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#1E3A5F" />
                                            <!--  Hover color  -->
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>

                            <!--  Enhanced cell styling with selection state  -->
                            <DataGrid.CellStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridCell}" TargetType="DataGridCell">
                                    <Setter Property="VerticalAlignment" Value="Center" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="Transparent" />
                                            <!--  Let row handle background  -->
                                            <Setter Property="BorderBrush" Value="Transparent" />
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.CellStyle>

                            <!--  Update column header style  -->
                            <DataGrid.ColumnHeaderStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}" TargetType="DataGridColumnHeader">
                                    <Setter Property="Foreground" Value="#FF4472C4" />
                                    <Setter Property="FontWeight" Value="Bold" />
                                    <Setter Property="FontFamily" Value="Segoe UI" />
                                    <Setter Property="FontSize" Value="12" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Height" Value="35" />
                                    <Setter Property="Background" Value="#1E1E1E" />
                                    <Setter Property="BorderBrush" Value="#3A3A3A" />
                                    <Setter Property="BorderThickness" Value="0,0,0,1" />
                                </Style>
                            </DataGrid.ColumnHeaderStyle>

                            <DataGrid.Columns>
                                <DataGridTextColumn
                                    Width="Auto"
                                    Binding="{Binding CustomerName}"
                                    Header="Customer / Student" />
                                <DataGridTextColumn
                                    Width="Auto"
                                    Binding="{Binding TotalOutstanding, StringFormat=C}"
                                    Header="Outstanding" />
                                <DataGridTextColumn
                                    Width="Auto"
                                    Binding="{Binding OverdueAmount, StringFormat=C}"
                                    Header="Overdue">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="#FF6B6B" />
                                            <Setter Property="FontWeight" Value="SemiBold" />
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn
                                    Width="Auto"
                                    Binding="{Binding AvgDaysToPay, StringFormat={}{0:F0}d}"
                                    Header="DSO" />
                                <DataGridTemplateColumn Width="Auto" Header="Action">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button
                                                Command="{Binding DataContext.ViewCustomerDetailsCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"
                                                Content="Details"
                                                Style="{StaticResource ModernMiniButton}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </Border>
            </Grid>
        </Grid>
    </ScrollViewer>
</base:BaseAnimatedPage>