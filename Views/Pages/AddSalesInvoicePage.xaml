<base:BaseAnimatedPage
    x:Class="PrimeAppBooks.Views.Pages.AddSalesInvoicePage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:base="clr-namespace:PrimeAppBooks.Views.Pages"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:hc="https://handyorg.github.io/handycontrol"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:pages="clr-namespace:PrimeAppBooks.ViewModels.Pages"
    xmlns:converters="clr-namespace:PrimeAppBooks.Conveters"
    d:DataContext="{d:DesignInstance Type=pages:AddSalesInvoicePageViewModel}"
    d:DesignHeight="900"
    d:DesignWidth="1280"
    Background="Transparent"
    mc:Ignorable="d">

    <base:BaseAnimatedPage.Resources>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter" />
    </base:BaseAnimatedPage.Resources>

    <ScrollViewer Style="{StaticResource ModernScrollViewer}">
        <Grid Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Header Section -->
            <Border Grid.Row="0" Margin="0,0,0,20" Style="{StaticResource ModernCardStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Style="{StaticResource WelcomeTitleText}" Text="Create Sales Invoice" />
                        <TextBlock Style="{StaticResource WelcomeSubtitleText}" Text="Create and post a new invoice for your customer" />
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button
                            Margin="5,0"
                            Command="{Binding NavigateBackCommand}"
                            Content="â† Back"
                            Style="{StaticResource ModernSecondaryButton}" />
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Form -->
            <Grid Grid.Row="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Invoice Details Header -->
                <Border Grid.Row="0" Margin="0,0,0,15" Style="{StaticResource ModernCardStyle}">
                    <Grid Margin="10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Invoice Number -->
                        <StackPanel Grid.Column="0" Margin="5">
                            <TextBlock Style="{StaticResource DetailLabelText}" Text="Invoice #" />
                            <TextBox IsEnabled="False" Style="{StaticResource ModernTextBoxStyle}" Text="{Binding InvoiceNumber}" />
                        </StackPanel>

                        <!-- Customer Selection -->
                        <StackPanel Grid.Column="1" Margin="5">
                            <TextBlock Style="{StaticResource DetailLabelText}" Text="Customer" />
                            <ComboBox
                                DisplayMemberPath="CustomerName"
                                ItemsSource="{Binding Customers}"
                                SelectedItem="{Binding SelectedCustomer}"
                                Style="{StaticResource ModernComboBox}" />
                        </StackPanel>

                        <!-- Dates -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                            <StackPanel Margin="5">
                                <TextBlock Style="{StaticResource DetailLabelText}" Text="Date" />
                                <DatePicker SelectedDate="{Binding InvoiceDate}" Style="{StaticResource CompactDatePickerStyle}" />
                            </StackPanel>
                            <StackPanel Margin="5">
                                <TextBlock Style="{StaticResource DetailLabelText}" Text="Due Date" />
                                <DatePicker SelectedDate="{Binding DueDate}" Style="{StaticResource CompactDatePickerStyle}" />
                            </StackPanel>
                        </StackPanel>

                        <!-- Multi-Currency -->
                        <StackPanel Grid.Column="3" Orientation="Horizontal">
                            <StackPanel Margin="5">
                                <TextBlock Style="{StaticResource DetailLabelText}" Text="Currency" />
                                <ComboBox
                                    Width="90"
                                    DisplayMemberPath="CurrencyCode"
                                    ItemsSource="{Binding Currencies}"
                                    SelectedItem="{Binding SelectedCurrency}"
                                    Style="{StaticResource ModernComboBox}" />
                            </StackPanel>
                            <StackPanel Margin="5">
                                <TextBlock Style="{StaticResource DetailLabelText}" Text="Ex. Rate" />
                                <hc:TextBox
                                    Width="80"
                                    hc:InfoElement.Placeholder="1.00"
                                    Style="{StaticResource ModernTextBoxStyle}"
                                    Text="{Binding ExchangeRate, StringFormat=N4, UpdateSourceTrigger=PropertyChanged}" />
                            </StackPanel>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Line Items Grid -->
                <Border Grid.Row="1" Margin="0,0,0,15" Style="{StaticResource ModernCardStyle}">
                    <Grid Margin="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                            <RowDefinition Height="Auto" />
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Margin="5" Style="{StaticResource SectionHeaderText}" Text="Line Items" />

                        <DataGrid
                            Grid.Row="1"
                            MaxHeight="400"
                            Margin="5"
                            AutoGenerateColumns="False"
                            BorderThickness="0"
                            CanUserAddRows="False"
                            CanUserDeleteRows="False"
                            GridLinesVisibility="None"
                            ItemsSource="{Binding BillLines}"
                            ScrollViewer.HorizontalScrollBarVisibility="Auto"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            Style="{StaticResource ModernDataGridStyle}">

                            <!--  Set row height and vertical alignment with enhanced selection state  -->
                            <DataGrid.RowStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridRow}" TargetType="DataGridRow">
                                    <Setter Property="Height" Value="60" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="VerticalAlignment" Value="Center" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="Foreground" Value="White" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="#2A4A7B" />
                                            <!--  Selected background color  -->
                                            <Setter Property="BorderBrush" Value="#4472C4" />
                                            <Setter Property="BorderThickness" Value="1" />
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="Background" Value="#1E3A5F" />
                                            <!--  Hover color  -->
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.RowStyle>

                            <!--  Enhanced cell styling with selection state  -->
                            <DataGrid.CellStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridCell}" TargetType="DataGridCell">
                                    <Setter Property="VerticalAlignment" Value="Center" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="BorderThickness" Value="0" />
                                    <Setter Property="Background" Value="Transparent" />
                                    <Setter Property="FocusVisualStyle" Value="{x:Null}" />
                                    <Style.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="Transparent" />
                                            <!--  Let row handle background  -->
                                            <Setter Property="BorderBrush" Value="Transparent" />
                                            <Setter Property="Foreground" Value="White" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGrid.CellStyle>

                            <!--  Update column header style  -->
                            <DataGrid.ColumnHeaderStyle>
                                <Style BasedOn="{StaticResource MaterialDesignDataGridColumnHeader}" TargetType="DataGridColumnHeader">
                                    <Setter Property="Foreground" Value="#FF4472C4" />
                                    <Setter Property="FontWeight" Value="Bold" />
                                    <Setter Property="FontFamily" Value="Segoe UI" />
                                    <Setter Property="FontSize" Value="12" />
                                    <Setter Property="VerticalContentAlignment" Value="Center" />
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                    <Setter Property="Height" Value="35" />
                                    <Setter Property="Background" Value="#1E1E1E" />
                                    <Setter Property="BorderBrush" Value="#3A3A3A" />
                                    <Setter Property="BorderThickness" Value="0,0,0,1" />
                                </Style>
                            </DataGrid.ColumnHeaderStyle>

                            <DataGrid.Columns>
                                <!-- Line Number -->
                                <DataGridTextColumn
                                    Width="Auto"
                                    Binding="{Binding LineNumber}"
                                    Header="#"
                                    IsReadOnly="True">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="VerticalAlignment" Value="Center" />
                                            <Setter Property="HorizontalAlignment" Value="Center" />
                                            <Setter Property="Foreground" Value="#7F8C8D" />
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>

                                <DataGridTemplateColumn Header="Account" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox
                                                DisplayMemberPath="FullName"
                                                ItemsSource="{Binding DataContext.Accounts, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                SelectedItem="{Binding SelectedAccount, UpdateSourceTrigger=PropertyChanged}"
                                                Style="{StaticResource ModernComboBox}" />
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTextColumn Header="Description" Binding="{Binding Description, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Qty" Binding="{Binding Quantity, UpdateSourceTrigger=PropertyChanged}" Width="Auto" />
                                <DataGridTextColumn Header="Unit Price" Binding="{Binding UnitPrice, UpdateSourceTrigger=PropertyChanged, StringFormat=N2}" Width="Auto" />
                                <DataGridTextColumn Header="Amount" Binding="{Binding Amount, StringFormat=N2}" IsReadOnly="True" Width="Auto" />
                                <DataGridTemplateColumn Header="Action" Width="Auto">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Button
                                                Command="{Binding DataContext.RemoveLineCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource ModernIconButton}"
                                                ToolTip="Remove Line">
                                                <Path
                                                    Width="12"
                                                    Height="12"
                                                    Data="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"
                                                    Fill="#E74C3C"
                                                    Stretch="Uniform" />
                                            </Button>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>

                        <StackPanel Grid.Row="0" HorizontalAlignment="Right">
                            <Button
                                Margin="5"
                                Command="{Binding AddLineCommand}"
                                Content="âž• Add Line"
                                Style="{StaticResource ModernSecondaryButton}" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Footer / Totals -->
                <Grid Grid.Row="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Border Grid.Column="0" Margin="0,0,10,0" Style="{StaticResource ModernCardStyle}">
                            <StackPanel Margin="10">
                                <TextBlock Style="{StaticResource DetailLabelText}" Text="Notes" />
                                <TextBox
                                    AcceptsReturn="True"
                                    Height="60"
                                    Style="{StaticResource ModernTextBoxStyle}"
                                    Text="{Binding Notes}"
                                    TextWrapping="Wrap" />
                            </StackPanel>
                        </Border>

                        <Border Grid.Column="1" MinWidth="250" Style="{StaticResource ModernCardStyle}">
                            <StackPanel Margin="20">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Style="{StaticResource SectionHeaderText}" Text="Total:" />
                                    <TextBlock Style="{StaticResource WelcomeTitleText}" Text="{Binding TotalAmount, StringFormat=C}" Foreground="#FF4EE2FF" />
                                </StackPanel>
                                <Grid Margin="0,20,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Button
                                        Grid.Column="0"
                                        Margin="0,0,5,0"
                                        Command="{Binding SaveDraftCommand}"
                                        Content="ðŸ’¾ Save Draft"
                                        Style="{StaticResource ModernSecondaryButton}" />
                                    <Button
                                        Grid.Column="1"
                                        Margin="5,0,0,0"
                                        Command="{Binding SaveAndPostCommand}"
                                        Content="ðŸš€ Create &amp; Post"
                                        Style="{StaticResource ModernActionButton}" />
                                </Grid>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <!-- Validation Summary Footer -->
                    <Border Grid.Row="1" Margin="0,10,0,0" Padding="15" CornerRadius="8" Background="#20FFFFFF">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Style="{StaticResource SectionHeaderText}" Text="ðŸ“‹ Validation Status" FontSize="14" Margin="0,0,0,10" />
                                <ItemsControl ItemsSource="{Binding ValidationErrors}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Foreground="#E74C3C" Text="{Binding}" Margin="0,2" FontSize="12" />
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <TextBlock Visibility="{Binding HasValidationErrors, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                                           Foreground="#2ECC71" Text="âœ“ All entries are valid and ready to post." FontSize="12" Margin="0,5" />
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- Loading Overlay -->
            <Border
                Grid.RowSpan="2"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ProgressBar
                        Width="80"
                        Height="80"
                        IsIndeterminate="True"
                        Style="{StaticResource MaterialDesignCircularProgressBar}" />
                    <TextBlock
                        Margin="0,15,0,0"
                        HorizontalAlignment="Center"
                        Style="{StaticResource DetailValueText}"
                        Text="Posting Invoice..." />
                </StackPanel>
            </Border>
        </Grid>
    </ScrollViewer>
</base:BaseAnimatedPage>